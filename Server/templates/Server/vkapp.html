<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <script src='http://code.jquery.com/jquery-1.11.2.js'></script>
    <script src='http://vk.com/js/api/xd_connection.js?2'></script>
    <style type="text/css">
        .date-pressed {
            background-color: red;
        }
        .sex-pressed {
            background-color: red;
        }
    </style>
</head>
<body>
    <div id="table-part">
        <table id="main-table">
        </table>
    </div>
<script>

function checkForUsersConfession (whoVkIdNumber) {
    var whoVkIdString = whoVkIdNumber.toString();
    //alert('here');
    $.getJSON('http://vklovers.herokuapp.com/users/' + whoVkIdString + '/who_confession/', {}, function(data) {
        for (i = 0; i < data.length; i++) {
            var toWhoVkIdString = data[i].to_who_vk_id;
            var currentType = data[i]['type'];
            //alert(currentType);
            if (currentType == 0) {
                //alert(toWhoVkIdString);
                //alert(typeof  toWhoVkIdString);
                $('#date' + toWhoVkIdString).addClass('date-pressed');
                //alert($('#date' + toWhoVkIdString).hasClass('date-pressed'));
                //$('#date' + toWhoVkIdString).remove();
            } else {
                $('#sex' + toWhoVkIdString).addClass('sex-pressed');
                //alert($('#sex' + toWhoVkIdString).hasClass('sex-pressed'));
                //$('#sex' + toWhoVkIdString).remove();
            }
        }
    });
}

function addRowToTableWithFriends (viewerUserIdNumber, cellUserIdNumber, photo, first_name, last_name) {
    var toWhoVkIdString = cellUserIdNumber.toString();
    var idDateString = "'date" + toWhoVkIdString + "'" ;
    var idSexString = "'sex" + toWhoVkIdString + "'" ;
    var valueDateString = "'" + toWhoVkIdString + "'" ;
    var valueSexString = "'" + toWhoVkIdString + "'" ;
    $('#main-table').append('<tr>' +
        '<td>' + "<img src='" + photo + "'>" + '</td>' +
        '<td>' + first_name + ' ' + last_name + '</td>' +
        '<td>' + "<button class='button-date' id=" + idDateString + ' value=' + valueDateString + '>' + 'Date'+ '</button>' + '</td>' +
        '<td>' + "<button class='button-sex' id=" + idSexString + ' value=' +  valueSexString + '>'  + 'Sex'+ '</button>' + '</td>' +
    '</tr>');

    /*
    $('#main-table').append('<tr>' +
        '<td>' + "<img src='" + photo + "'>" + '</td>' +
        '<td>' + first_name + ' ' + last_name + '</td>' +
        '<td>' + "<button class='button-date' id='date" + cellUserIdNumber.toString() +
            + "' value='" + cellUserIdNumber.toString() + "'>" + 'Date'+ '</button>' + '</td>' +
        '<td>' + "<button class='button-sex' id='sex" + cellUserIdNumber.toString() +
            + "' value='" + cellUserIdNumber.toString() + "'>"  + 'Sex'+ '</button>' + '</td>' +
    '</tr>');*/
}

function makeTableWithFriends(viewerUserIdNumber, viewerUserSex) {
    VK.api('friends.get', {order: 'hints', fields: 'id, first_name, last_name, sex, photo_50' }, function(data) {
        switch (viewerUserSex) {
            case 0: {
                for(i = 0; i < data.response.length; i++) {
                    addRowToTableWithFriends(viewerUserIdNumber, data.response[i].uid, data.response[i].photo_50,
                            data.response[i].first_name, data.response[i].last_name);
                }
                break;
            }
            case 1: {
                for(i = 0; i < data.response.length; i++) {
                    if (data.response[i].sex == 2)
                        addRowToTableWithFriends(viewerUserIdNumber,  data.response[i].uid, data.response[i].photo_50,
                                data.response[i].first_name, data.response[i].last_name);
                }
                break;
            }
            case 2: {
                for(i = 0; i < data.response.length; i++) {
                    if (data.response[i].sex == 1)
                        addRowToTableWithFriends(viewerUserIdNumber, data.response[i].uid, data.response[i].photo_50,
                                data.response[i].first_name, data.response[i].last_name);
                }
                break;
            }
        }
    });
    $('#main-table').load(checkForUsersConfession(viewerUserIdNumber));
}

function callBackOnClickToDateButton (whoVkIdString, toWhoVkIdString) {
    var flagDatePressed = $(this).hasClass('date-pressed');
    var flagSexPressed = $(this).hasClass('sex-pressed');
    if ((flagDatePressed == false) && (flagSexPressed == false)) {
        $(this).addClass('date-pressed');
        var confessionInfo = {who_vk_id: whoVkIdString, to_who_vk_id: toWhoVkIdString, type: 0};
        $.ajax({
            url: 'http://vklovers.herokuapp.com/users/' + whoVkIdString + '/who_confession/',
            type: 'POST',
            data: JSON.stringify(confessionInfo),
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            async: false
        });
    }
    if ((flagDatePressed == true) && (flagSexPressed == false)) {
        $(this).removeClass('date-pressed');
        $.ajax({
            url: 'http://vklovers.herokuapp.com/users/' + whoVkIdString + '/who_confession/' + toWhoVkIdString + '/',
            type: "DELETE"
        });
    }
    if ((flagDatePressed == false) && (flagSexPressed == true)) {
        $(this).addClass('date-pressed');
        $('#sex' + toWhoVkIdString).removeClass('sex-pressed');
        var confessionInfo = {who_vk_id: whoVkIdString, to_who_vk_id: toWhoVkIdString, type: 0};
        $.ajax({
            url: 'http://vklovers.herokuapp.com/users/' + whoVkIdString + '/who_confession/',
            type: 'POST',
            data: JSON.stringify(confessionInfo),
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            async: false
        });
    }
}

function callBackOnClickToSexButton (whoVkIdString, toWhoVkIdString) {
    var flagDatePressed = $(this).hasClass('date-pressed');
    var flagSexPressed = $(this).hasClass('sex-pressed');
    if ((flagDatePressed == false) && (flagSexPressed == false)) {
        $(this).addClass('sex-pressed');
        var confessionInfo = {who_vk_id: whoVkIdString, to_who_vk_id: toWhoVkIdString, type: 1};
        $.ajax({
            url: 'http://vklovers.herokuapp.com/users/' + whoVkIdString + '/who_confession/',
            type: 'POST',
            data: JSON.stringify(confessionInfo),
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            async: false
        });
    }
    if ((flagDatePressed == false) && (flagSexPressed == true)) {
        $(this).removeClass('sex-pressed');
        $.ajax({
            url: 'http://vklovers.herokuapp.com/users/' + whoVkIdString + '/who_confession/' + toWhoVkIdString + '/',
            type: "DELETE"
        });
    }
    if ((flagDatePressed == true) && (flagSexPressed == false)) {
        $(this).addClass('sex-pressed');
        $('#date' + toWhoVkIdString).removeClass('date-pressed');
        var confessionInfo = {who_vk_id: whoVkIdString, to_who_vk_id: toWhoVkIdString, type: 0};
        $.ajax({
            url: 'http://vklovers.herokuapp.com/users/' + whoVkIdString + '/who_confession/',
            type: 'POST',
            data: JSON.stringify(confessionInfo),
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            async: false
        });
    }
}

function interActionWithViewer(viewerUserIdNumber) {
    var whoVkIdString = viewerUserIdNumber.toString();
    $('#table-part').on('click', 'button', function() {
        var toWhoVkIdString = $(this).attr('value');
        if ($(this).hasClass('button-date') == true) {
            callBackOnClickToDateButton(whoVkIdString, toWhoVkIdString);
        } else {
            callBackOnClickToSexButton(whoVkIdString, toWhoVkIdString);
        }
    });
}

function initSuccess () {
    VK.api('users.get', {fields: 'sex'}, function(dataFromVk) {
        var viewerUserIdNumber = dataFromVk.response[0].uid;
        var userInfo = {vk_id: viewerUserIdNumber.toString(), email: 'unknown@unknown.com', mobile: 'unknown'};
        $.ajax({
            url: 'http://vklovers.herokuapp.com/users/',
            type: 'POST',
            data: JSON.stringify(userInfo),
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            async: false,
            success: function() {
                // What should I do if User once been in app?
                //alert('Welcome!')
            },
            error: function() {
                // What should I do else?
                //alert("You've been here!")
            }
        });
        makeTableWithFriends(viewerUserIdNumber, dataFromVk.response[0].sex);
        interActionWithViewer(viewerUserIdNumber);
    });
}

$(document).ready(
    VK.init(initSuccess())
);

</script>
</body>
</html>